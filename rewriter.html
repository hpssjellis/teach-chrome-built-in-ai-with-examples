<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome AI: Simple Rewriter Example</title>
</head>

<body style="font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px;">
    <h1 style="color: #4CAF50;">Chrome Built-in AI: Simple Rewriter</h1>
    <p>This example shows how to use the <code>Rewriter.rewrite()</code> method to rephrase a given text. This is a non-streaming operation.</p>

    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: #f9f9f9;">
        <h2 style="margin-top: 0;">Text to Rewrite</h2>
        <textarea id="myTextInput" rows="10" placeholder="Paste the text you want to rewrite here..."
            style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">The team has decided to move forward with the new project timeline. We will begin the implementation phase next Monday, following the successful completion of the preliminary research. All relevant stakeholders have been notified, and we anticipate a smooth transition.</textarea>
        <button id="myExecuteButton" onclick="myExecuteRewriter()"
            style="display: block; width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; color: white; background-color: #4CAF50; border: none; border-radius: 5px; cursor: pointer;">Create
            Session and Rewrite</button>
    </div>

    <div style="margin-top: 20px;">
        <h2 style="margin-top: 0;">Status and Output</h2>
        <p id="myStatus" style="font-style: italic; color: #555;">Ready. Paste text and click the button.</p>
        <textarea id="myOutput" rows="5" readonly
            style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #eee; box-sizing: border-box; margin-top: 10px;"></textarea>
    </div>

    <hr style="margin: 40px 0;">

    <div>
        <h2>A Note on Chrome Flags and Origin Trial</h2>
        <p>To use this feature, you must have the Rewriter API flag enabled in Chrome AND register for the origin trial. Open a new tab, paste the link below, press Enter, enable the flag, and then restart Chrome.</p>
        <input type="text" id="flagsLink" value="chrome://flags/#rewriter-api-for-gemini-nano" readonly
            style="width: 100%; padding: 8px; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer;"
            onclick="myCopyFlagsLink()">
        <br>
        <button onclick="myCopyFlagsLink()" style="margin-top: 10px; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Copy Link & Open New Tab</button>
        <p style="margin-top: 15px;"><strong>Note:</strong> The Rewriter API is currently in origin trial (Chrome 137-142). You may need to register at: <a href="https://developer.chrome.com/origintrials/#/view_trial/444167513249415169" target="_blank">Rewriter API Origin Trial</a></p>
    </div>

    <hr style="margin: 40px 0;">
   
    <div>
        <h2>My GitHub</h2>
        <p>You can find more of my work on my <a href="https://github.com/hpssjellis"> hpssjellis </a> GitHub page:</p>
        <p> By Jeremy Ellis <a href="https://ca.linkedin.com/in/jeremy-ellis-4237a9bb"> LinkedIn </a><br></p>
    </div>

    <script>
        // Use my descriptive names and camelCase
        let myTimerInterval = null;
        let myRewriter = null; // Store rewriter instance

        // Function to start a simple timer to show activity
        function myStartTimer() {
            let mySeconds = 0;
            const myStatus = document.getElementById('myStatus');
            myStatus.textContent = "Working... 0s";
            myTimerInterval = setInterval(() => {
                mySeconds++;
                myStatus.textContent = `Working... ${mySeconds}s`;
            }, 1000);
        }

        // Function to stop the timer and set the final status
        function myStopTimer(myMessage) {
            if (myTimerInterval) {
                clearInterval(myTimerInterval);
                myTimerInterval = null;
            }
            const myStatus = document.getElementById('myStatus');
            myStatus.textContent = myMessage;
        }

        // Main function to create the session and execute the rewriter
        async function myExecuteRewriter() {
            const myTextInput = document.getElementById('myTextInput');
            const myOutput = document.getElementById('myOutput');
            const myStatus = document.getElementById('myStatus');
            const myExecuteButton = document.getElementById('myExecuteButton');

            myExecuteButton.disabled = true;
            myExecuteButton.style.backgroundColor = '#ccc';

            try {
                // Check if Rewriter API is available
                if (!window.Rewriter) {
                    myStopTimer("Error: Rewriter API not available. Check Chrome version (137+), flags, and origin trial registration.");
                    return;
                }

                // Check availability first
                const availability = await Rewriter.availability();
                
                if (availability === "unavailable") {
                    myStopTimer("Error: Rewriter not available. Please check chrome://on-device-internals for model status.");
                    return;
                }

                if (availability === "after-download") {
                    myStopTimer("Rewriter model needs to be downloaded. Please wait and try again later.");
                    return;
                }

                myStartTimer();
                myOutput.value = "";

                const myTextValue = myTextInput.value;
                if (!myTextValue.trim()) {
                    myStopTimer('Please enter text to rewrite.');
                    return;
                }

                // Create rewriter with proper language configuration if not already created
                if (!myRewriter) {
                    myStatus.textContent = 'Creating rewriter session...';
                    
                    // Rewriter API: sharedContext sets the language/behavior context
                    // No explicit language parameters - it uses the sharedContext
                    myRewriter = await Rewriter.create({
                        sharedContext: 'Rewrite content maintaining clarity and meaning in English.',
                        tone: 'as-is',
                        format: 'as-is',
                        length: 'as-is',
                        monitor(m) {
                            m.addEventListener("downloadprogress", e => {
                                console.log(`Downloaded ${e.loaded * 100}%`);
                                myStatus.textContent = `Downloading model: ${Math.round(e.loaded * 100)}%`;
                            });
                        }
                    });
                }

                myStatus.textContent = 'Rewriting text...';

                // Use the rewrite() method on the rewriter instance
                const myRewrittenText = await myRewriter.rewrite(myTextValue);
                myOutput.value = myRewrittenText;
                myStopTimer("Rewrite complete!");

            } catch (myError) {
                myRewriter = null; // Reset on error
                
                let errorMessage = "An error occurred: " + myError.message;
                
                if (myError.message && myError.message.includes('not available')) {
                    errorMessage = "Rewriter API not available. Ensure flags are enabled, model is downloaded, and you're registered for the origin trial.";
                } else if (myError.message && myError.message.includes('language')) {
                    errorMessage = "Language configuration error. The model supports English, Spanish, and Japanese.";
                } else if (myError.message && myError.message.includes('Rewriter')) {
                    errorMessage = "Rewriter API not found. Make sure you're using Chrome 137+ with the flag enabled and have registered for the origin trial.";
                }
                
                myStopTimer(errorMessage);
                console.error("Error:", myError);
            } finally {
                myExecuteButton.disabled = false;
                myExecuteButton.style.backgroundColor = '#4CAF50';
            }
        }

        // Helper function to copy the flags link and open a new tab
        function myCopyFlagsLink() {
            const myFlagsInput = document.getElementById('flagsLink');
            myFlagsInput.select();
            myFlagsInput.setSelectionRange(0, 99999);
            document.execCommand('copy');
            window.open('about:blank', '_blank');
        }
    </script>
</body>
</html>
